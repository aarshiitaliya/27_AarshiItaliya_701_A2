<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Portal - Leave Management</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Leave Management</h1>
            <div class="user-info">
                <span class="user-name" id="userName">Loading...</span>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>

        <nav class="nav">
            <ul class="nav-links">
                <li><a href="/profile">Profile</a></li>
                <li><a href="/leave" class="active">Leave Management</a></li>
            </ul>
        </nav>

        <div id="alertContainer"></div>

        <!-- Leave Application Form -->
        <div class="card">
            <h2>Apply for Leave</h2>
            <div class="leave-form">
                <form id="leaveForm">
                    <div class="form-group">
                        <label for="leaveDate">Leave Date</label>
                        <input type="date" id="leaveDate" name="leaveDate" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="reason">Reason for Leave</label>
                        <textarea id="reason" name="reason" class="form-control" rows="4" 
                                placeholder="Please provide a detailed reason for your leave request (minimum 10 characters)" 
                                required minlength="10" maxlength="500"></textarea>
                        <small style="color: #718096;">Characters: <span id="charCount">0</span>/500</small>
                    </div>
                    
                    <button type="submit" class="btn" id="submitBtn">
                        <span id="submitText">Submit Leave Application</span>
                        <div id="submitSpinner" class="spinner" style="display: none;"></div>
                    </button>
                </form>
            </div>
        </div>

        <!-- Leave Applications List -->
        <div class="card">
            <h2>My Leave Applications</h2>
            <div class="leave-list">
                <div id="loadingLeaves" class="loading">
                    <div class="spinner"></div>
                    <p>Loading leave applications...</p>
                </div>
                <div id="leavesList" style="display: none;"></div>
                <div id="noLeaves" style="display: none; text-align: center; color: #718096; padding: 2rem;">
                    <p>No leave applications found. Apply for your first leave above!</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function() {
            checkAuth();
            loadLeaveApplications();
            setMinDate();
            
            // Character counter for reason textarea
            $('#reason').on('input', function() {
                const length = $(this).val().length;
                $('#charCount').text(length);
                
                if (length < 10) {
                    $(this).css('border-color', '#e53e3e');
                } else if (length > 450) {
                    $(this).css('border-color', '#d69e2e');
                } else {
                    $(this).css('border-color', '#48bb78');
                }
            });
        });

        function checkAuth() {
            const token = localStorage.getItem('employeeToken');
            if (!token) {
                window.location.href = '/';
                return;
            }

            const employeeInfo = JSON.parse(localStorage.getItem('employeeInfo') || '{}');
            $('#userName').text(employeeInfo.fullName || 'Employee');
        }

        function setMinDate() {
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            const minDate = tomorrow.toISOString().split('T')[0];
            $('#leaveDate').attr('min', minDate);
        }

        $('#leaveForm').on('submit', function(e) {
            e.preventDefault();
            
            const leaveDate = $('#leaveDate').val();
            const reason = $('#reason').val().trim();
            
            if (!leaveDate || !reason) {
                showAlert('Please fill in all fields', 'error');
                return;
            }
            
            if (reason.length < 10) {
                showAlert('Reason must be at least 10 characters long', 'error');
                return;
            }
            
            // Show loading state
            $('#submitBtn').prop('disabled', true);
            $('#submitText').hide();
            $('#submitSpinner').show();
            
            const token = localStorage.getItem('employeeToken');
            
            $.ajax({
                url: '/api/employee/leave/apply',
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                data: JSON.stringify({ leaveDate, reason }),
                success: function(response) {
                    if (response.success) {
                        showAlert('Leave application submitted successfully!', 'success');
                        $('#leaveForm')[0].reset();
                        $('#charCount').text('0');
                        $('#reason').css('border-color', '#e2e8f0');
                        loadLeaveApplications(); // Refresh the list
                    } else {
                        showAlert(response.message || 'Failed to submit leave application', 'error');
                    }
                },
                error: function(xhr) {
                    if (xhr.status === 401) {
                        logout();
                    } else {
                        const response = xhr.responseJSON;
                        showAlert(response?.message || 'Failed to submit leave application. Please try again.', 'error');
                    }
                },
                complete: function() {
                    // Hide loading state
                    $('#submitBtn').prop('disabled', false);
                    $('#submitText').show();
                    $('#submitSpinner').hide();
                }
            });
        });

        function loadLeaveApplications() {
            const token = localStorage.getItem('employeeToken');
            
            $.ajax({
                url: '/api/employee/leave/list',
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                success: function(response) {
                    if (response.success) {
                        displayLeaveApplications(response.leaveApplications);
                    } else {
                        showAlert('Failed to load leave applications', 'error');
                    }
                },
                error: function(xhr) {
                    if (xhr.status === 401) {
                        logout();
                    } else {
                        showAlert('Failed to load leave applications. Please try again.', 'error');
                    }
                },
                complete: function() {
                    $('#loadingLeaves').hide();
                }
            });
        }

        function displayLeaveApplications(applications) {
            const container = $('#leavesList');
            
            if (applications.length === 0) {
                $('#noLeaves').show();
                return;
            }
            
            let html = '';
            applications.forEach(function(leave) {
                html += `
                    <div class="leave-item">
                        <div class="leave-header">
                            <div class="leave-date">${leave.leaveDate}</div>
                            <div class="status ${leave.status}">${leave.status}</div>
                        </div>
                        <div class="leave-reason">
                            <strong>Reason:</strong> ${leave.reason}
                        </div>
                        <div class="leave-meta">
                            Applied on: ${leave.appliedDate}
                            ${leave.reviewDate ? `| Reviewed on: ${leave.reviewDate}` : ''}
                            ${leave.comments ? `<br><strong>Comments:</strong> ${leave.comments}` : ''}
                        </div>
                    </div>
                `;
            });
            
            container.html(html).show();
        }

        function logout() {
            localStorage.removeItem('employeeToken');
            localStorage.removeItem('employeeInfo');
            window.location.href = '/';
        }

        function showAlert(message, type) {
            const alertClass = type === 'success' ? 'alert-success' : 'alert-error';
            const alertHtml = `<div class="alert ${alertClass}">${message}</div>`;
            $('#alertContainer').html(alertHtml);
            
            setTimeout(() => {
                $('#alertContainer').empty();
            }, 5000);
        }
    </script>
</body>
</html>
